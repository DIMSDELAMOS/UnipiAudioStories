package com.example.unipiaudiostories;

import android.content.Intent;
import android.content.res.Configuration;
import android.content.res.Resources;
import android.os.Bundle;
import android.util.DisplayMetrics;
import android.view.View;
import android.widget.AdapterView;
import android.widget.Button;
import android.widget.Spinner;
import androidx.appcompat.app.AppCompatActivity;
import androidx.recyclerview.widget.LinearLayoutManager;
import androidx.recyclerview.widget.RecyclerView;
import java.util.List;
import java.util.Locale;

public class Stories extends AppCompatActivity {

    Spinner languageSpinner;
    RecyclerView recyclerView;
    Button btnStats;
    DatabaseHelper dbHelper;
    String[] languageNames = {"Ελληνικά", "English", "Français"};   //οι γλωσσες σε σειρα: ελληνικα->0, αγγλικα ->1, γαλλικα->2
    int[] languageFlags = {R.drawable.flag_gr, R.drawable.flag_en, R.drawable.flag_fr};
    String[] languageCodes = {"el", "en", "fr"};

    boolean isUserInteracting = false;  //αποφυγη loop στην εκκινηση

    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_stories);

        languageSpinner = findViewById(R.id.spinner);  //ρυθμιση του spinner για τις γλωσσες
        LanguageAdapter adapter = new LanguageAdapter(this, languageNames, languageFlags);
        languageSpinner.setAdapter(adapter);

        String currentLang = getResources().getConfiguration().locale.getLanguage();
        if (currentLang.equals("en")) {
            languageSpinner.setSelection(1);   //αγγλικα
        } else if (currentLang.equals("fr")) {
            languageSpinner.setSelection(2);   //γαλλικα
        } else {
            languageSpinner.setSelection(0);   //ελληνικα
        }

        recyclerView = findViewById(R.id.recyclerViewStories); //recyclerView
        recyclerView.setLayoutManager(new LinearLayoutManager(this));

        dbHelper = new DatabaseHelper(this);  //βαση δεδομενων
        List<Story> stories = dbHelper.getAllStories();

        if (stories.isEmpty()) {
            Fairytales();
            stories = dbHelper.getAllStories();
        }

        StoryAdapter storyAdapter = new StoryAdapter(this, stories);
        recyclerView.setAdapter(storyAdapter);

        btnStats = findViewById(R.id.btnStats);  //στατιστικα
        btnStats.setOnClickListener(v -> {
            startActivity(new Intent(Stories.this, com.example.unipiaudiostories.StatisticsActivity.class));
        });

        languageSpinner.setOnItemSelectedListener(new AdapterView.OnItemSelectedListener() {   //αλλαγη γλωσσας
            @Override
            public void onItemSelected(AdapterView<?> parent, View view, int position, long id) {
                if (isUserInteracting) {
                    String selectedLang = languageCodes[position];
                    String currentLang = getResources().getConfiguration().locale.getLanguage();
                    if (!selectedLang.equals(currentLang)) {  //αλλαζει η γλωσσα αν ειναι διαφορετικη
                        setLocale(selectedLang);
                    }
                }
            }

            @Override
            public void onNothingSelected(AdapterView<?> parent) {}
        });
    }

    @Override
    public void onUserInteraction() {
        super.onUserInteraction();
        isUserInteracting = true;
    }

    private void Fairytales() {   //εδω φυλασσονται οι ιστοριες
        dbHelper.addStory("Η Κοκκινοσκουφίτσα", "Αδερφοι Γκριμ",
                "Μια φορά κι έναν καιρό, ένα μικρό κορίτσι που φορούσε πάντα ένα κόκκινο σκουφάκι πήγε να επισκεφθεί τη γιαγιά του στο δάσος. Στον δρόμο συνάντησε έναν πονηρό λύκο, που την ξεγέλασε και έφτασε πρώτος στο σπίτι της γιαγιάς. Όμως, με τη βοήθεια ενός γενναίου κυνηγού, η Κοκκινοσκουφίτσα και η γιαγιά σώθηκαν. Από τότε, το κορίτσι έμαθε να προσέχει και να μην μιλά σε αγνώστους.", R.drawable.redhead);

        dbHelper.addStory("Τα τρία Γουρουνάκια", "Λαικο Παραμυθι",
                "Μια φορά κι έναν καιρό, τρία γουρουνάκια έφτιαξαν το καθένα το δικό του σπίτι. Το πρώτο από άχυρο, το δεύτερο από ξύλο και το τρίτο από τούβλα. Όταν ήρθε ο κακός λύκος, μόνο το γερό σπίτι άντεξε. Έτσι, τα γουρουνάκια έμαθαν πως η δουλειά και η υπομονή φέρνουν ασφάλεια.", R.drawable.gourounakia);

        dbHelper.addStory("Η πεντάμορφη και το Τέρας", "Γκαμπριελ-Σουζαν",
                "Μια φορά κι έναν καιρό, ένας έμπορος έχασε την περιουσία του και ζούσε φτωχικά με τα παιδιά του. Η μικρότερη κόρη του, η Πεντάμορφη, ήταν καλή και γεμάτη αγάπη. Όταν ο πατέρας της έκοψε ένα τριαντάφυλλο από το κάστρο ενός Τέρατος, εκείνη πήγε να ζήσει μαζί του για να τον σώσει. Παρόλο που το Τέρας ήταν τρομακτικό, φερόταν με καλοσύνη και σεβασμό. Με τον καιρό, η Πεντάμορφη κατάλαβε ότι η αληθινή ομορφιά κρύβεται στην καρδιά.", R.drawable.pentamorfi_teras);

        dbHelper.addStory("Ο λαγός και η χελώνα", "Αισωπος",
                "Μια φορά κι έναν καιρό, ένας γρήγορος λαγός κορόιδευε μια αργή χελώνα. Αποφάσισαν να κάνουν έναν αγώνα δρόμου. Ο λαγός σταμάτησε να ξεκουραστεί, αλλά η χελώνα συνέχισε χωρίς να τα παρατήσει. Τελικά, έφτασε πρώτη και έμαθε σε όλους πως η επιμονή νικά την αλαζονεία.", R.drawable.lagos_xelwna);

        dbHelper.addStory("Η Σταχτοπούτα", "Σαρλ Περω",
                "Μια φορά κι έναν καιρό, ζούσε η Σταχτοπούτα, ένα καλό και ταπεινό κορίτσι που την κακομεταχειρίζονταν η μητριά και οι αδελφές της. Με τη βοήθεια της νεράιδας νονάς της πήγε στον βασιλικό χορό, όπου γνώρισε τον πρίγκιπα. Με ένα γυάλινο γοβάκι, η αγάπη τους βρέθηκε και η Σταχτοπούτα έζησε ευτυχισμένη.", R.drawable.staxtopouta);
    }

    public void setLocale(String lang) {    //αλλαγη της γλωσσας και επανεκκινηση του activity
        Locale myLocale = new Locale(lang);
        Resources res = getResources();
        DisplayMetrics dm = res.getDisplayMetrics();
        Configuration conf = res.getConfiguration();
        conf.setLocale(myLocale);
        res.updateConfiguration(conf, dm);
        Intent refresh = new Intent(this, Stories.class);  //επαννεκινηση για να εφαρμοστει η γλωσσα που επιλεχθηκε
        startActivity(refresh);
        finish();
    }
}